<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RockMovies - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="test.css">
</head>
<body class="sl-theme-light">

    <div class="dashboard">
        <aside class="sidebar" id="sidebar">
            <div class="logo"><i class="fas fa-film"></i> taL</div>
            <nav class="user-nav">
                <a href="#" class="active"><i class="fas fa-house"></i> Home</a>
                <a href="#"><i class="fas fa-clapperboard"></i> Meus Filmes</a>
                <a href="#"><i class="fas fa-shopping-cart"></i> Carrinho</a>
                <a href="#"><i class="fas fa-clock-rotate-left"></i> Histórico</a>
                <a href="#"><i class="fas fa-user"></i> Minha Conta</a>
                <a href="#" style="margin-top: auto; color: #ef4444;"><i class="fas fa-right-from-bracket"></i> Sair</a>
            </nav>
        </aside>

        <header class="navbar">
            <div class="nav-top">
                <div class="menu-toggle" onclick="toggleMenu()"><i class="fas fa-bars"></i></div>
                <div class="search-container">
                    <div class="search-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <input type="text" placeholder="Pesquisar filmes...">
                    <select class="search-dropdown">
                        <option>Título</option>
                        <option>Ator</option>
                        <option>Ano</option>
                        <option>Data</option>
                        <option>Letra</option>
                    </select>
                </div>
                <div class="nav-icons">
                    <div class="cart-wrapper"><i class="fas fa-shopping-basket"></i><span class="cart-count">3</span></div>
                    <i class="fas fa-bell"></i>
                </div>
            </div>
            <div class="categories-bar">
                <span class="cat-item active">Todos</span>
                <span class="cat-item">Ação</span>
                <span class="cat-item">Comédia</span>
                <span class="cat-item">Drama</span>
            </div>
        </header>

        <main class="content">
            <section class="hero" id="hero-section">
                <div id="hero-bg" class="hero-backdrop"></div>
                <div id="player" style="opacity: 0; transition: opacity 0.8s;"></div> 

                <h1 id="hero-title"><div class="skeleton skeleton-title"></div></h1>

                <div class="video-controls-side">
                    <button id="btn-pause" class="side-ctrl"><i class="fas fa-pause"></i></button>
                    <button id="btn-audio" class="side-ctrl"><i class="fas fa-volume-mute"></i></button>
                </div>

                <div class="hero-footer">
                    <div id="hero-overview">
                        <div class="skeleton skeleton-text"></div>
                        <div class="skeleton skeleton-text" style="width: 80%"></div>
                    </div>
                    <div id="skeleton-btn" class="skeleton skeleton-button"></div>
                    <button class="btn-hero" id="btn-fullscreen" style="display: none;"><i class="fas fa-eye-low-vision"></i></button>
                </div>
            </section>

            <section class="movie-list">
                <h2 style="margin-bottom: 1.5rem;">Filmes Populares</h2>
                <div class="grid-movies" id="grid-movies">
                    <div class="grid-skeleton"></div>
                    <div class="grid-skeleton"></div>
                    <div class="grid-skeleton"></div>
                    <div class="grid-skeleton"></div>
                </div>
            </section>
        </main>

        <footer class="footer">
            <p>&copy; 2026 MovieRental Store - Paleta Amber & Sidebar Fixa</p>
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        var player;
        var currentVideoId = '';

        function toggleMenu() { document.getElementById('sidebar').classList.toggle('active'); }

        function onYouTubeIframeAPIReady() {
            // A API está pronta, mas aguardamos o ID do TMDB para criar o player
        }

        function createPlayer(videoId) {
            player = new YT.Player('player', {
                height: '100%', width: '100%', videoId: videoId,
                playerVars: { 'autoplay': 1, 'mute': 1, 'controls': 0, 'loop': 1, 'playlist': videoId },
                events: {
                    'onReady': (e) => {
                        e.target.playVideo();
                        document.getElementById('player').style.opacity = "1";
                    },
                    'onStateChange': onPlayerStateChange
                }
            });
            setupHeroControls();
        }

        function onPlayerStateChange(event) {
            const videoEl = document.getElementById('player');
            // Se pausar, mostra o fundo. Se der play, mostra o vídeo.
            if (event.data === YT.PlayerState.PAUSED) {
                videoEl.style.opacity = "0";
            } else if (event.data === YT.PlayerState.PLAYING) {
                videoEl.style.opacity = "1";
            }
        }

        function setupHeroControls() {
            document.getElementById('btn-audio').onclick = function() {
                if (player.isMuted()) {
                    player.unMute();
                    this.innerHTML = '<i class="fas fa-volume-up"></i>';
                } else {
                    player.mute();
                    this.innerHTML = '<i class="fas fa-volume-mute"></i>';
                }
            };

            document.getElementById('btn-pause').onclick = function() {
                if (player.getPlayerState() === YT.PlayerState.PLAYING) {
                    player.pauseVideo();
                    this.innerHTML = '<i class="fas fa-play"></i>';
                } else {
                    player.playVideo();
                    this.innerHTML = '<i class="fas fa-pause"></i>';
                }
            };
        }
    </script>

    <script type="module">
        import { getPopularMovies, getMovieTrailer, IMG_URL } from './utils/api.js';

        async function init() {
            try {
                const movies = await getPopularMovies();
                
                if (movies.length > 0) {
                    const featured = movies[0];
                    // Configura a imagem de fundo IMEDIATAMENTE
                    const bgUrl = `https://image.tmdb.org/t/p/original${featured.backdrop_path}`;
                    document.getElementById('hero-bg').style.backgroundImage = `url(${bgUrl})`;
                    
                    document.getElementById('hero-title').innerText = featured.title;
                    document.getElementById('hero-overview').innerText = featured.overview;
                    document.getElementById('skeleton-btn')?.remove();
                    document.getElementById('btn-fullscreen').style.display = 'block';

                    const trailerUrl = await getMovieTrailer(featured.id);
                    if (trailerUrl) {
                        const videoId = trailerUrl.split('embed/')[1].split('?')[0];
                        // Aguarda um pouco para o usuário ver a capa e depois inicia o vídeo
                        setTimeout(() => createPlayer(videoId), 1500);
                    }
                }

                renderGrid(movies);
            } catch (error) { console.error(error); }
        }

        // --- RENDERIZAÇÃO DA GRID ---
        function renderGrid(movies) {
            const grid = document.getElementById('grid-movies');
            grid.innerHTML = movies.map(movie => `
                <div class="movie-card" onmouseenter="playPreview(this, ${movie.id})">
                    <div class="card-visual-container">
                        <div class="poster-side">
                            <img src="https://image.tmdb.org/t/p/w500${movie.poster_path}" class="card-img" loading="lazy">
                            <div class="poster-story-overlay">
                                <p class="story-text">${movie.overview ? movie.overview.substring(0, 90) + '...' : 'Sem descrição.'}</p>
                            </div>
                        </div>
                        <div class="video-preview-side" id="preview-${movie.id}">
                            <div class="preview-loading"><i class="fas fa-circle-notch fa-spin"></i></div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="movie-info">
                            <h3 class="movie-title">${movie.title}</h3>
                            <span class="movie-rating">★ ${movie.vote_average.toFixed(1)}</span>
                        </div>
                        <button class="btn-round add-to-cart" data-id="${movie.id}">
                            <i class="fas fa-cart-plus"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            // Eventos de clique para o carrinho
            document.querySelectorAll('.add-to-cart').forEach(btn => {
                btn.onclick = () => {
                    cartCount++;
                    document.getElementById('cart-counter').innerText = cartCount;
                    btn.style.transform = "scale(0.8)";
                    setTimeout(() => btn.style.transform = "", 200);
                };
            });
        }

        // Função global para o hover (Preview)
        window.playPreview = async function(el, id) {
            const container = document.getElementById(`preview-${id}`);
            if (container.querySelector('iframe')) return;
            const url = await getMovieTrailer(id);
            if (url) {
                container.innerHTML = `<iframe src="${url}&autoplay=1&mute=1&controls=0" frameborder="0"></iframe>`;
            }
        };
        init();
    </script>
</body>
</html>